#!/bin/bash

set -e

# Default values
SOURCE_DIR="home"
INSTALL_DIR="$HOME"
LN_ARGS=()
QUIET=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --force)
            LN_ARGS+=("--force")
            ;;
        --quiet)
            QUIET=true
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            # Break out of the loop when we hit positional args
            break
            ;;
    esac
    shift
done

# Handle positional arguments
if [[ $# -gt 0 ]]; then
    SOURCE_DIR="$1"
    shift
    if [[ $# -gt 0 ]]; then
        INSTALL_DIR="$1"
        shift
        # Check if there are more arguments (which would be too many)
        if [[ $# -gt 0 ]]; then
            echo "Error: Too many positional arguments. Expected at most 2: SOURCE_DIR and INSTALL_DIR." >&2
            exit 1
        fi
    else
        echo "Error: If SOURCE_DIR is provided, INSTALL_DIR must also be provided." >&2
        exit 1
    fi
fi

INSTALL_FILES=$(cd "${SOURCE_DIR}" && find ./* -type f)

mkdir_args=()
ln_args_local=("${LN_ARGS[@]}" -s)
diff_args=()

if [ "$QUIET" = false ]; then
  mkdir_args+=(-v)
  ln_args_local+=(-v)
  diff_args+=(--report-identical-files)
fi

for f in ${INSTALL_FILES}; do
	target_file=$(echo "${INSTALL_DIR}/$f" | sed 's#dot-#.#g')
	source_file="${PWD}/${SOURCE_DIR}/$f"

	if ! [ -h "${target_file}" ] || [ "$(readlink -- "${target_file}")" != "${source_file}" ]; then
		if mkdir "${mkdir_args[@]}" -p "$(dirname "${target_file}")"; then
			if [[ ! "${target_file}" == */.dummy ]]; then
				if [ "$QUIET" = true ]; then
					ln "${ln_args_local[@]}" "${source_file}" "${target_file}" 2>/dev/null || diff "${diff_args[@]}" -U 3 "${source_file}" "${target_file}" || true
				else
					ln "${ln_args_local[@]}" "${source_file}" "${target_file}" || diff --report-identical-files "${source_file}" "${target_file}" || true
				fi
			fi
		else
			echo "Error: can't create $(dirname "${target_file}")"
		fi
	fi
done
