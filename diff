#!/bin/bash

set -euo pipefail

# Default values
source_dir="home"
install_dir="$HOME"
quiet=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --quiet|-q)
            quiet=true
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            # Break out of the loop when we hit positional args
            break
            ;;
    esac
    shift
done

# Handle positional arguments
if [[ $# -gt 0 ]]; then
    source_dir="$1"
    shift
    if [[ $# -gt 0 ]]; then
        install_dir="$1"
        shift
        # Check if there are more arguments (which would be too many)
        if [[ $# -gt 0 ]]; then
            echo "Error: Too many positional arguments. Expected at most 2: source_dir and install_dir." >&2
            exit 1
        fi
    else
        echo "Error: If source_dir is provided, install_dir must also be provided." >&2
        exit 1
    fi
fi

install_files=$(cd "${source_dir}" && find ./* -type f | sed -r 's#^[.]/##')

diff_args=(-U 3)

if [ "$quiet" = false ]; then
  diff_args+=(--report-identical-files)
fi

for f in ${install_files}; do
  target_file=$(echo "${install_dir}/$f" | sed 's#dot-#.#g')

  if ! [[ "${target_file}" =~ [.]dummy$ ]]; then
    source_file="${PWD}/${source_dir}/$f"
    diff "${diff_args[@]}" "${source_file}" "${target_file}" || true
  fi
done
